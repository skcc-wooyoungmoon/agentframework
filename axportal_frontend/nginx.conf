server {
    listen 8080;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip 설정
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript;

    # HTML 파일은 캐시 완전 비활성화 (Edge 100+ 호환성 강화)
    location ~* \.html$ {
        # Edge 100+ 캐시 정책 충돌 방지
        expires epoch;  # -1 대신 epoch 사용
        add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "Thu, 01 Jan 1970 00:00:00 GMT";  # 명시적 과거 날짜
        # Edge 100+ 브라우저 최적화
        add_header X-UA-Compatible "IE=edge";
        # Edge 100+ 특정 헤더 추가
        add_header Clear-Site-Data "cache";  # 사이트 캐시 강제 클리어
        # add_header Content-Type "application/javascript; charset=utf-8"; # 1113 1013
    }

    # config.js 파일은 캐시 비활성화
    location = /config.js {
        expires epoch;
        add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "Thu, 01 Jan 1970 00:00:00 GMT";
        add_header Content-Type "application/javascript; charset=utf-8";
    }

    # 폰트 파일 설정 (woff, woff2, ttf, eot 등) - woff 다운로드 멈춤 해결
    # WOFF2 파일
    location ~* \.woff2$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";  # CORS 허용
        add_header Vary "Accept-Encoding";
        add_header Content-Type "font/woff2";
    }
    
    # WOFF 파일
    location ~* \.woff$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";  # CORS 허용
        add_header Vary "Accept-Encoding";
        add_header Content-Type "font/woff";
    }
    
    # TTF, EOT, OTF 파일
    location ~* \.(ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";  # CORS 허용
        add_header Vary "Accept-Encoding";
        add_header Content-Type "application/font-sfnt";
    }

    # JS/CSS 파일은 적당한 캐싱 (Edge 100+ ETag 검증 강화)
    location ~* \.(js|css)$ {
        expires 30d;
        add_header Cache-Control "public, must-revalidate";  # must-revalidate 추가
        etag on;  
        # Edge 100+ ETag 검증 강제
        add_header Vary "Accept-Encoding";
        # Edge 100+ 조건부 요청 보장
        if ($http_if_none_match = "") {
            add_header Cache-Control "public, must-revalidate, max-age=0";
        }
    }

    # 이미지 파일은 기존대로 유지
    location ~* \.(png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA 라우팅 (Edge 100+ 호환성 강화)
    location / {
        try_files $uri $uri/ /index.html;
        # Edge 100+ 캐시 방지 강화
        expires epoch;
        add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "Thu, 01 Jan 1970 00:00:00 GMT" always;
        # Edge 100+ 브라우저 최적화
        add_header X-UA-Compatible "IE=edge" always;
        # Edge 100+ 사이트 데이터 클리어
        add_header Clear-Site-Data "cache" always;
    }

    # 보안 헤더 + Edge 100+ 최적화
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; font-src 'self' data: *;" always;

    # 보안 취약점 Nginx 버전 숨기기
    server_tokens off;
}